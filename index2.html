<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡πÄ‡∏Å‡∏°‡∏ó‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
    background:#111;
    color:white;
    text-align:center;
    font-family:sans-serif;
    margin-top:50px;
}
input, button, select {
    padding:10px;
    font-size:16px;
    margin:5px;
}
#result { font-size:22px; margin-top:20px; }
#score { margin-top:10px; }
</style>
</head>

<body>

<h1>üé≤ ‡πÄ‡∏Å‡∏°‡∏ó‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h1>

<input id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏∂‡∏á">
<select id="room">
    <option value="room1">‡∏´‡πâ‡∏≠‡∏á 1</option>
    <option value="room2">‡∏´‡πâ‡∏≠‡∏á 2</option>
    <option value="room3">‡∏´‡πâ‡∏≠‡∏á 3</option>
</select>
<br>

<input type="number" id="guess" placeholder="‡πÄ‡∏î‡∏≤‡πÄ‡∏•‡∏Ç 1-100">
<br>

<button onclick="check()">‡πÄ‡∏î‡∏≤‡πÄ‡∏•‡∏¢‡πÑ‡∏≠‡πâ‡∏™‡∏±‡∏™</button>
<button onclick="resetGame()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏≠‡∏ö üîÑ</button>

<div id="result"></div>
<div id="score"></div>

<script>
/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyDRlB6q1NJeSnO4JsLQcUHr28XGKo573sk",
  authDomain: "peem-dc962.firebaseapp.com",
  databaseURL: "https://peem-dc962-default-rtdb.firebaseio.com",
  projectId: "peem-dc962",
  storageBucket: "peem-dc962.firebasestorage.app",
  messagingSenderId: "1021248731842",
  appId: "1:1021248731842:web:0e8b4ec8e0f51e0578595b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let answer = 0;

function getRoomPath() {
    return "rooms/" + document.getElementById("room").value;
}

/* ‡∏ü‡∏±‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á */
function listenRoom() {
    const path = getRoomPath();

    db.ref(path + "/answer").on("value", snap => {
        if (snap.exists()) answer = snap.val();
    });

    db.ref(path + "/winner").on("value", snap => {
        if (snap.exists()) {
            document.getElementById("result").innerText =
                "‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ: " + snap.val();
        }
    });

    db.ref(path + "/scores").on("value", snap => {
        let text = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:\n";
        snap.forEach(s => {
            text += s.key + " = " + s.val() + " | ";
        });
        document.getElementById("score").innerText = text;
    });
}

listenRoom();

document.getElementById("room").addEventListener("change", () => {
    listenRoom();
});

/* ‡πÄ‡∏î‡∏≤ */
function check() {
    const name = document.getElementById("name").value;
    const g = document.getElementById("guess").value;
    const path = getRoomPath();

    if (name === "" || g === "") {
        document.getElementById("result").innerText =
            "‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏¥‡πÑ‡∏≠‡πâ‡πÄ‡∏´‡∏µ‡πâ‡∏¢";
        return;
    }

    if (g > answer) {
        document.getElementById("result").innerText = "‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡πÄ‡∏ß‡πâ‡∏¢";
    } else if (g < answer) {
        document.getElementById("result").innerText = "‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏ß‡∏∞";
    } else {
        document.getElementById("result").innerText =
            "‡∏ñ‡∏π‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏≠‡πâ‡πÄ‡∏´‡∏µ‡πâ‡∏¢ üéâ";

        const scoreRef = db.ref(path + "/scores/" + name);
        scoreRef.get().then(snap => {
            let score = snap.exists() ? snap.val() : 0;
            scoreRef.set(score + 1);
        });

        db.ref(path + "/winner").set(name);
        db.ref(path + "/status").set("finished");
    }
}

/* ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï */
function resetGame() {
    const path = getRoomPath();
    const newAnswer = Math.floor(Math.random() * 100) + 1;

    db.ref(path + "/answer").set(newAnswer);
    db.ref(path + "/winner").remove();
    db.ref(path + "/status").set("playing");

    document.getElementById("result").innerText =
        "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏ß‡πâ‡∏¢ üî•";
}
</script>

</body>
</html>
